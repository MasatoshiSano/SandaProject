以下のロジックで、計画PPHを正しく計算してください。
計画では、計画機種順に生産します。
計画PPhを格納するテーブルも作成してください。
計画が記入されたら、記入された日の計画PPHを自動で計算してください。
計画PPHは、各ラインごとに作成してください。
機械ごとには要りません。

## 1. 前回結果のクリア

* **目的**：同じ日付で計算結果が重複しないよう、過去に保存された「計画PPH」のレコードをすべて削除します。
* **イメージ**：ホワイトボードをいったん消して、今日の計算結果だけを書く準備をする、というイメージです。

---

## 2. 時間帯の設定取得

* **目的**：例えば「毎時00分から計算」ではなく「毎時30分から計算開始」といったように、各ライン毎に各時間ブロックの開始位置をWorkCalendar設定から読み込みます。
* **イメージ**：「08:00−09:00」ではなく「08:30−09:30」のように、開始・終了を少しずらすための時刻を取得する

---

## 3. 実際の生産スタート時刻決定

* **朝礼や清掃の長さ**を管理している設定（morning_meeting_duration）があれば、その終了後をスタート時刻とし、なければWorkCalendarのwork_start_time固定で開始します。
* **イメージ**：朝会や清掃が終わる「合図」が鳴ったところから生産を始める、という感じです。

---

## 4. 休憩時間のリストアップ

* **当日分と翌朝（0:00～work_start_time）の休憩**をすべて集め、一つの「休憩一覧」にまとめます。
* **イメージ**：お昼休みや15時の小休憩など、生産を止める時間帯をカレンダーに赤くマークしていく感じです。

---

## 5. 段替え（機種切り替え）の所要時間マップ作成

* **機械Aから機械Bへ切り替えるときにかかるダウンタイム**を、PartChangeDowntimeから組み合わせごとに秒数でまとめます。データがない場合はデフォルト600秒です。
* **イメージ**：車のギアを「1速→2速」に変えるときに少しエンジンを止めるように、機械も切り替えに時間がかかる前提を持ちます。

---

## 6. 生産イベント（稼働区間）の生成

1. **計画リストを順番に取り出す**
2. 各計画について、

   * 必要な「作業秒数」を求める（計画個数×１個あたりのサイクル時間）
   * **現在時刻ポインタ**（開始時刻からの進捗を示す）を動かしながら

     * もし休憩時間帯に入ったら、休憩終了時刻までポインタを飛ばす
     * それ以外の時間帯で、次の休憩または翌朝work_start_timeまで、どれだけ連続稼働できるかを計算し、
       「この区間で何秒分生産するか」を切り出してイベントとして記録
   * 必要秒数が０になるまで繰り返す
3. **計画間の段替え時間**をポインタに加算してから、次の計画へ進む

* **イメージ**：

  1. 「機械Aを100個作るのに500秒かかります」として、
  2. 休憩や昼休みは飛ばしつつ、
  3. たとえば08:30〜10:00の間に300秒、10:00〜10:30の間に200秒…といった具合に、
  4. 生産できる時間帯を小分けしてリスト化していく作業です。

---

## 7. 残りユニット数の管理

* 各計画で「まだ何個残っているか」を記録しておき、あふれないようにキャップ（上限調整）します。
* **イメージ**：100個作る計画なら最初は100、60個作ったら残りは40…とカウントダウンしていくイメージ。

---

## 8. 各時間帯ごとに「作れた個数」を集計して保存

1. 【当日work_start_time〜23:59】と【翌日0:00〜work_start_time】の２つのフェーズでそれぞれループを回す
2. 各１時間ブロックについて、

   * 先ほど作った生産イベントリストから、そのブロックと重なる区間を探す
   * 重なる秒数をサイクルタイムで割って「何個作れるか」を計算
   * 残りユニット数を超えないように調整
   * 最終的にその時間帯で作った個数をデータベースに保存
   * 保存した分だけ残りユニット数を減らす
3. 翌日の時間帯は「時間＋24」で区別

* **イメージ**：

  * 「09:30〜10:30」に生産イベントが200秒分あれば、一個あたりの秒数で割って「5個作れた！」と集計し、
  * それを「9時台（または翌日○時台）」の欄に書き込む、という作業です。

---

## 9. 終了ログの出力

* 何件保存したかを最終的にログに出し、「計算完了」の合図を出します。
* **イメージ**：ホワイトボードに「今日の合計：120件保存しました！」と書いて終わり。

---

以上が、仕事の流れをそのままコード化した「計算ロジック」の全体像です。
休憩や段替えといった“生産停止時間”をすべて除外しながら、１秒たりともムダなく時間を割り振って「何時に何個作れるか」を正確に割り出す仕組みになっています。